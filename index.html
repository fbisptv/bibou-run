<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cyber Bibou Evolution</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 20px; box-sizing: border-box; }
        .hud { color: #fff; font-size: 18px; text-shadow: 0 0 10px #0ff; display: flex; justify-content: space-between; }
        .vies { color: #ff4757; font-size: 24px; }
        #msg-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); border: 2px solid #0ff; padding: 30px; text-align: center; color: #fff; display: none; z-index: 100; min-width: 280px; border-radius: 10px; }
        button { background: #0ff; border: none; padding: 12px 25px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; margin-top: 15px; border-radius: 5px; }
        #powerup-ui { position: absolute; top: 60px; left: 20px; display: flex; gap: 10px; }
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; display: none; text-transform: uppercase; }
        #rotate { display: none; position: fixed; inset: 0; background: #000; color: #0ff; z-index: 999; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        @media (orientation: portrait) { #rotate { display: flex; } }
    </style>
</head>
<body>
    <div id="rotate"><h2>ðŸ”„ TOURNER L'Ã‰CRAN</h2><p>Le hockey du futur se joue en paysage !</p></div>
    <div id="ui">
        <div class="hud">
            <div>CREDITS: <span id="coins">0</span></div>
            <div id="lvl-name">LVL 1: BANLIEUE BLEUE</div>
            <div class="vies" id="vies">â™¥â™¥â™¥</div>
        </div>
        <div id="powerup-ui">
            <div id="badge-shield" class="badge" style="background: #1e90ff; border: 1px solid #fff;">BOUCLIER</div>
            <div id="badge-jump" class="badge" style="background: #2ed573; border: 1px solid #fff;">SUPER SAUT</div>
        </div>
    </div>
    <div id="msg-box">
        <h2 id="msg-title">CYBER BIBOU</h2>
        <p id="msg-text">PrÃªt pour le match ?</p>
        <button onclick="handleBtn()">START</button>
    </div>
    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let w, h;

// ParamÃ¨tres de jeu
let gameState = 'START';
let currentLevel = 1;
let score = 0;
let lives = 3;
let cameraX = 0;
let invincibility = 0;

// Power-ups
let hasShield = false;
let jumpBoost = 0;

const player = {
    x: 100, y: 0, w: 45, h: 75, vx: 0, vy: 0,
    grounded: false, dir: 1, anim: 0
};

let platforms = [], spikes = [], coins = [], powerups = [], particles = [], deco = [];

const LVL_THEMES = {
    1: { name: "BANLIEUE BLEUE", color: "#00d2ff", bg: "#000510", decoType: "tours" },
    2: { name: "DESERT CYBER", color: "#ff9f43", bg: "#1a0a00", decoType: "montagnes" },
    3: { name: "STATION LHC", color: "#ff4757", bg: "#0d0210", decoType: "espace" }
};

function init() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    if(gameState === 'PLAYING') generateLevel();
}
window.onresize = init;

function generateLevel() {
    platforms = []; spikes = []; coins = []; powerups = []; deco = [];
    const theme = LVL_THEMES[currentLevel];
    document.getElementById('lvl-name').innerText = `LVL ${currentLevel}: ${theme.name}`;
    document.getElementById('lvl-name').style.color = theme.color;

    let cx = 0;
    let cy = h - 100;

    // DÃ©cor de fond
    for(let i=0; i<15; i++) {
        deco.push({
            x: Math.random() * 5000,
            y: theme.decoType === 'tours' ? h : Math.random() * h/2,
            w: 50 + Math.random() * 100,
            h: 100 + Math.random() * 300,
            speed: 0.1 + Math.random() * 0.2
        });
    }

    // Sol de dÃ©part
    platforms.push({x: 0, y: cy, w: 600, h: 500});
    cx = 600;

    const length = 50 + (currentLevel * 15); // Niveaux plus courts (environ 60-80 blocs)
    
    for(let i=0; i<length; i++) {
        let gap = Math.random() < 0.2;
        let step = (Math.random() - 0.5) * 120;
        cy += step;
        if(cy > h - 80) cy = h - 80;
        if(cy < 200) cy = 200;

        let pw = 150 + Math.random() * 200;
        if(!gap) {
            platforms.push({x: cx, y: cy, w: pw, h: 600});
            // Items
            if(Math.random() < 0.4) coins.push({x: cx + pw/2, y: cy - 40, r: 12, collected: false});
            if(Math.random() < 0.15) spikes.push({x: cx + 20, y: cy - 20, w: 40, h: 25});
            // Powerups
            if(i === 15) powerups.push({x: cx + pw/2, y: cy - 50, type: 'shield'});
            if(i === 35) powerups.push({x: cx + pw/2, y: cy - 50, type: 'jump'});
        }
        cx += pw + (gap ? 120 : 0);
    }

    // Fin
    platforms.push({x: cx, y: cy, w: 400, h: 600});
    flag = {x: cx + 150, y: cy - 100};
    player.x = 100; player.y = cy - 100;
    player.vx = 0; player.vy = 0;
}

// ContrÃ´les
let keys = {};
let touch = { active: false, x: 0 };
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

canvas.ontouchstart = e => {
    const t = e.touches[0];
    if(t.clientX > w/2) { if(player.grounded) jump(); }
    else { touch.active = true; touch.x = t.clientX; }
};
canvas.ontouchmove = e => { if(touch.active) touch.x = e.touches[0].clientX; };
canvas.ontouchend = () => { touch.active = false; keys['ArrowRight'] = keys['ArrowLeft'] = false; };

function jump() {
    player.vy = jumpBoost > 0 ? -20 : -14;
    player.grounded = false;
}

function handleBtn() {
    if(gameState === 'START' || gameState === 'GAMEOVER' || gameState === 'WIN') {
        currentLevel = 1; score = 0; lives = 3;
    } else if(gameState === 'CLEAR') {
        currentLevel++;
    }
    hasShield = false; jumpBoost = 0;
    gameState = 'PLAYING';
    document.getElementById('msg-box').style.display = 'none';
    generateLevel();
}

function update() {
    if(gameState !== 'PLAYING') return;

    // Mouvement
    let input = 0;
    if(keys['ArrowRight']) input = 1;
    if(keys['ArrowLeft']) input = -1;
    if(touch.active) {
        if(touch.x < w/4) input = -1;
        else if(touch.x < w/2) input = 1;
    }

    if(input !== 0) {
        player.vx += input * 0.8;
        player.dir = input;
        player.anim += 0.2;
    } else {
        player.vx *= 0.85;
    }
    
    player.vx = Math.max(-8, Math.min(8, player.vx));
    player.vy += 0.6; // GravitÃ©
    player.x += player.vx;
    player.y += player.vy;

    // Sol et Collision
    player.grounded = false;
    for(let p of platforms) {
        if(player.x + player.w > p.x && player.x < p.x + p.w && player.y + player.h > p.y && player.y + player.h < p.y + 50) {
            if(player.vy >= 0) {
                player.y = p.y - player.h;
                player.vy = 0;
                player.grounded = true;
            }
        }
    }

    // Mort chute
    if(player.y > h + 100) takeDamage(true);

    // Collision Spikes
    if(invincibility <= 0) {
        for(let s of spikes) {
            if(rectIntersect(player.x+5, player.y+5, player.w-10, player.h-10, s.x, s.y, s.w, s.h)) {
                takeDamage();
            }
        }
    } else {
        invincibility--;
    }

    // Coins (Hitbox amÃ©liorÃ©e)
    for(let c of coins) {
        if(!c.collected && rectIntersect(player.x-10, player.y-10, player.w+20, player.h+20, c.x-c.r, c.y-c.r, c.r*2, c.r*2)) {
            c.collected = true;
            score += 10;
            document.getElementById('coins').innerText = score;
        }
    }

    // Powerups
    for(let p of powerups) {
        if(!p.used && rectIntersect(player.x, player.y, player.w, player.h, p.x-15, p.y-15, 30, 30)) {
            p.used = true;
            if(p.type === 'shield') hasShield = true;
            if(p.type === 'jump') jumpBoost = 600; // 10 secondes
        }
    }

    if(jumpBoost > 0) jumpBoost--;
    document.getElementById('badge-shield').style.display = hasShield ? 'block' : 'none';
    document.getElementById('badge-jump').style.display = jumpBoost > 0 ? 'block' : 'none';

    // Fin de niveau
    if(player.x > flag.x) {
        if(currentLevel >= 3) victory();
        else levelClear();
    }

    // Camera
    cameraX += (player.x - cameraX - w/3) * 0.1;
    if(cameraX < 0) cameraX = 0;
    
    // UI Vies
    document.getElementById('vies').innerText = "â™¥".repeat(Math.max(0, lives));
}

function takeDamage(instant = false) {
    if(hasShield && !instant) {
        hasShield = false;
        invincibility = 100;
        return;
    }
    lives--;
    if(lives <= 0) {
        gameState = 'GAMEOVER';
        showMsg("GAME OVER", "Le LHC a perdu ce soir... Recommence Tintin !");
    } else {
        player.x -= 200;
        player.y -= 100;
        player.vx = 0;
        invincibility = 120;
    }
}

function levelClear() {
    gameState = 'CLEAR';
    showMsg("NIVEAU RÃ‰USSI", `Bien jouÃ© Bibou ! Direction le prochain match.`);
}

function victory() {
    gameState = 'WIN';
    showMsg("CHAMPION !", `INCROYABLE ! Tintin et MÃ©lanie ont gagnÃ© la coupe ! Score: ${score}`);
}

function showMsg(title, text) {
    document.getElementById('msg-title').innerText = title;
    document.getElementById('msg-text').innerText = text;
    document.getElementById('msg-box').style.display = 'block';
}

function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
    return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
}

function draw() {
    const theme = LVL_THEMES[currentLevel];
    ctx.fillStyle = theme.bg;
    ctx.fillRect(0,0,w,h);

    // Dessin dÃ©cor parallaxe
    ctx.fillStyle = theme.color + "22";
    for(let d of deco) {
        let dx = (d.x - cameraX * d.speed) % (w + 400);
        if(dx < -200) dx += (w + 400);
        if(theme.decoType === 'montagnes') {
            ctx.beginPath();
            ctx.moveTo(dx, h); ctx.lineTo(dx + d.w, h - d.h); ctx.lineTo(dx + d.w*2, h);
            ctx.fill();
        } else {
            ctx.fillRect(dx, h - d.h, d.w, d.h);
        }
    }

    ctx.save();
    ctx.translate(-cameraX, 0);

    // Plateformes
    ctx.shadowBlur = 10;
    ctx.shadowColor = theme.color;
    ctx.fillStyle = "#000";
    ctx.strokeStyle = theme.color;
    ctx.lineWidth = 2;
    for(let p of platforms) {
        ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.strokeRect(p.x, p.y, p.w, p.h);
    }

    // Spikes
    ctx.shadowColor = "#ff4757";
    ctx.fillStyle = "#ff4757";
    for(let s of spikes) {
        ctx.beginPath();
        ctx.moveTo(s.x, s.y+s.h); ctx.lineTo(s.x+s.w/2, s.y); ctx.lineTo(s.x+s.w, s.y+s.h);
        ctx.fill();
    }

    // Coins
    ctx.shadowColor = "#f1c40f";
    ctx.fillStyle = "#f1c40f";
    for(let c of coins) {
        if(!c.collected) {
            ctx.beginPath();
            ctx.arc(c.x, c.y + Math.sin(Date.now()/200)*5, c.r, 0, Math.PI*2);
            ctx.fill();
        }
    }

    // Powerups
    for(let p of powerups) {
        if(!p.used) {
            ctx.fillStyle = p.type === 'shield' ? '#1e90ff' : '#2ed573';
            ctx.shadowColor = ctx.fillStyle;
            ctx.fillRect(p.x-15, p.y-15 + Math.sin(Date.now()/150)*8, 30, 30);
            ctx.strokeRect(p.x-15, p.y-15 + Math.sin(Date.now()/150)*8, 30, 30);
        }
    }

    // Flag (Bien visible au dessus du sol)
    ctx.fillStyle = "#fff";
    ctx.fillRect(flag.x, flag.y, 5, 100);
    ctx.fillStyle = theme.color;
    ctx.beginPath();
    ctx.moveTo(flag.x+5, flag.y); ctx.lineTo(flag.x+60, flag.y+25); ctx.lineTo(flag.x+5, flag.y+50);
    ctx.fill();

    // Player
    if(!(invincibility > 0 && Math.floor(Date.now()/100) % 2 === 0)) {
        drawPlayer(player.x, player.y, theme.color);
    }

    ctx.restore();
    requestAnimationFrame(() => { update(); draw(); });
}

function drawPlayer(x, y, color) {
    ctx.save();
    ctx.translate(x + player.w/2, y + player.h/2);
    if(player.dir === -1) ctx.scale(-1, 1);

    // Corps (Style Hockeyeur Cyber)
    ctx.fillStyle = "#e74c3c"; // Rouge LHC
    ctx.fillRect(-15, -15, 30, 35);
    ctx.fillStyle = "#fff"; // Blanc LHC
    ctx.fillRect(-15, -5, 30, 8);
    
    // Casque
    ctx.fillStyle = "#2c3e50";
    ctx.beginPath();
    ctx.arc(0, -25, 18, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "#0ff"; // VisiÃ¨re
    ctx.fillRect(5, -30, 12, 5);

    // Jambes
    let legY = Math.sin(player.anim) * 10;
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 4;
    ctx.beginPath(); ctx.moveTo(-8, 20); ctx.lineTo(-12, 35 + legY); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(8, 20); ctx.lineTo(12, 35 - legY); ctx.stroke();

    // Shield effect
    if(hasShield) {
        ctx.strokeStyle = "#1e90ff";
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(0, 0, 50, 0, Math.PI*2); ctx.stroke();
    }
    // Jump effect
    if(jumpBoost > 0) {
        ctx.fillStyle = "#2ed57355";
        ctx.beginPath(); ctx.moveTo(-20, 30); ctx.lineTo(0, 50); ctx.lineTo(20, 30); ctx.fill();
    }

    ctx.restore();
}

init();
draw();
</script>
</body>
</html>

