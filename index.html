<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bibou Adventure - Les Bibous</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #0d0d15;
            touch-action: none; font-family: 'Orbitron', sans-serif;
            user-select: none; -webkit-user-select: none;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%;
            pointer-events: none; display: flex; justify-content: space-between;
            padding: 20px; box-sizing: border-box; z-index: 10;
        }
        .hud-text {
            color: #0ff; font-size: 20px; text-shadow: 0 0 10px #0ff;
            font-weight: bold; letter-spacing: 2px;
        }
        #vies-count { color: #ff4757; font-size: 24px; text-shadow: 0 0 10px #ff4757; }
        
        #message-box {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(13, 13, 21, 0.95); color: white;
            padding: 40px; border-radius: 15px; text-align: center;
            display: none; pointer-events: auto; border: 2px solid #0ff;
            box-shadow: 0 0 30px #0ff; z-index: 20; min-width: 300px;
        }
        button {
            background: transparent; color: #0ff; border: 2px solid #0ff;
            padding: 15px 30px; font-size: 18px; margin-top: 20px;
            cursor: pointer; font-family: 'Orbitron', sans-serif;
            text-transform: uppercase; box-shadow: 0 0 10px #0ff;
        }
        button:active { background: #0ff; color: #000; }
        
        #rotate-hint {
            display: none; position: fixed; inset: 0; background: #0d0d15;
            z-index: 9999; flex-direction: column; align-items: center;
            justify-content: center; color: #0ff; text-align: center;
        }
        @media screen and (orientation: portrait) { #rotate-hint { display: flex; } }
    </style>
</head>
<body>

    <div id="rotate-hint">
        <div style="font-size: 50px;">ðŸ“±</div>
        <h2>TOURNE TON Ã‰CRAN</h2>
        <p>Mode paysage requis pour l'aventure !</p>
    </div>

    <div id="ui-layer">
        <div id="vies-count">â™¥â™¥â™¥</div>
        <div class="hud-text" id="level-name">NIVEAU 1</div>
        <div class="hud-text">CREDITS: <span id="score-val">0</span></div>
    </div>

    <div id="message-box">
        <h2 id="msg-title">BIBOU ADVENTURE</h2>
        <p id="msg-text">PrÃªt pour l'aventure, Tintin ?</p>
        <button onclick="handleBtnClick()">LANCER</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/**
 * BIBOU ADVENTURE - ENGINE V4
 * Fixes: Lives system, Hitboxes, Powerups, Decor shifts
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- CONFIG ---
const GRAVITY = 0.6;
const FRICTION = 0.85;
const JUMP_FORCE = -15;

const THEMES = [
    { name: "VILLE CYAN", color: "#00ffff", bg: "#050d15", sky: "#0a1a2e" },
    { name: "NEON PINK", color: "#ff00ff", bg: "#150515", sky: "#2e0a2e" },
    { name: "ENFER SOLAIRE", color: "#ffaa00", bg: "#151005", sky: "#2e1a0a" }
];

// --- STATE ---
let gameState = 'start'; // start, playing, death, next_level, win
let level = 1;
let score = 0;
let lives = 3;
let invulFrame = 0;
let cameraX = 0;
let gameTime = 0;

let platforms = [], spikes = [], coins = [], powerups = [], particles = [], buildings = [];
let flag = { x: 0, y: 0 };

const bibou = {
    x: 100, y: 0, w: 40, h: 65, vx: 0, vy: 0,
    grounded: false, dir: 1, 
    shield: false, superJump: 0
};

// Controls
let inputX = 0;

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    genBuildings();
}
window.addEventListener('resize', resize);

function genBuildings() {
    buildings = [];
    for(let i=0; i<20; i++) {
        buildings.push({
            x: i * 300,
            w: 100 + Math.random() * 200,
            h: 150 + Math.random() * 350,
            speed: 0.2 + Math.random() * 0.1
        });
    }
}

function initLevel() {
    platforms = []; spikes = []; coins = []; powerups = []; particles = [];
    cameraX = 0;
    bibou.x = 100; bibou.y = 100; bibou.vx = 0; bibou.vy = 0;
    bibou.shield = false; bibou.superJump = 0;
    invulFrame = 0;

    const theme = THEMES[level-1];
    document.getElementById('level-name').innerText = theme.name;
    document.getElementById('level-name').style.color = theme.color;
    document.getElementById('level-name').style.textShadow = `0 0 10px ${theme.color}`;

    let cx = 0;
    let cy = canvas.height - 100;

    // Start
    platforms.push({ x: 0, y: cy, w: 600, h: 600 });
    cx = 600;

    for(let i=0; i < 30 + (level*5); i++) {
        let gap = Math.random() < 0.2;
        if(gap) cx += 150 + Math.random() * 100;

        let pw = 200 + Math.random() * 300;
        cy += (Math.random() - 0.5) * 150;
        cy = Math.max(canvas.height * 0.4, Math.min(canvas.height - 80, cy));

        platforms.push({ x: cx, y: cy, w: pw, h: 800 });

        // Items logic
        if(Math.random() < 0.4) coins.push({ x: cx + pw/2, y: cy - 60, r: 12, collected: false });
        if(Math.random() < 0.15) spikes.push({ x: cx + 50, y: cy - 25, w: 40, h: 25 });
        
        // Powerups
        if(i === 10) powerups.push({ x: cx + pw/2, y: cy - 60, type: 'shield', active: true });
        if(i === 20) powerups.push({ x: cx + pw/2, y: cy - 60, type: 'jump', active: true });

        cx += pw + 2;
    }

    // End Flag - Bien posÃ© au dessus du sol
    platforms.push({ x: cx, y: cy, w: 400, h: 800 });
    flag = { x: cx + 200, y: cy - 100 }; 
}

// --- LOGIC ---

function handleBtnClick() {
    if(gameState === 'start' || gameState === 'win' || gameState === 'gameover') {
        level = 1; score = 0; lives = 3;
        document.getElementById('score-val').innerText = "0";
        startGame();
    } else if(gameState === 'next_level') {
        level++;
        startGame();
    }
}

function startGame() {
    document.getElementById('message-box').style.display = 'none';
    gameState = 'playing';
    initLevel();
    requestAnimationFrame(loop);
}

// Input Touch
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const t = e.touches[0];
    if(t.clientX > canvas.width / 2) {
        if(bibou.grounded) {
            bibou.vy = (bibou.superJump > 0) ? JUMP_FORCE * 1.3 : JUMP_FORCE;
            bibou.grounded = false;
        }
    } else {
        inputX = (t.clientX < canvas.width / 4) ? -1 : 1;
    }
}, {passive: false});

canvas.addEventListener('touchend', () => inputX = 0);

// Keyboard
window.onkeydown = (e) => {
    if(e.code === 'ArrowRight') inputX = 1;
    if(e.code === 'ArrowLeft') inputX = -1;
    if(e.code === 'Space' && bibou.grounded) {
        bibou.vy = (bibou.superJump > 0) ? JUMP_FORCE * 1.3 : JUMP_FORCE;
        bibou.grounded = false;
    }
};
window.onkeyup = () => inputX = 0;

function update() {
    if(gameState !== 'playing') return;
    gameTime += 0.05;

    // Physics
    if(inputX !== 0) {
        bibou.vx += inputX * 0.7;
        bibou.dir = inputX;
    } else {
        bibou.vx *= FRICTION;
    }
    
    bibou.vx = Math.max(-9, Math.min(9, bibou.vx));
    bibou.vy += GRAVITY;
    bibou.x += bibou.vx;
    bibou.y += bibou.vy;

    // Platform collisions
    bibou.grounded = false;
    platforms.forEach(p => {
        if(bibou.x + bibou.w > p.x && bibou.x < p.x + p.w &&
           bibou.y + bibou.h > p.y && bibou.y + bibou.h < p.y + 30 && bibou.vy >= 0) {
            bibou.y = p.y - bibou.h;
            bibou.vy = 0;
            bibou.grounded = true;
        }
    });

    // Hitbox detection (Plus large pour bonus, plus serrÃ©e pour piÃ¨ges)
    const checkHit = (bx, by, bw, bh, ox, oy, ow, oh, padding = 0) => {
        return bx + padding < ox + ow && bx + bw - padding > ox &&
               by + padding < oy + oh && by + bh - padding > oy;
    };

    // Coins - Hitbox gÃ©nÃ©reuse
    coins.forEach(c => {
        if(!c.collected && checkHit(bibou.x, bibou.y, bibou.w, bibou.h, c.x-c.r, c.y-c.r, c.r*2, c.r*2, -10)) {
            c.collected = true; score += 10;
            document.getElementById('score-val').innerText = score;
            createParticles(c.x, c.y, 8, "#ffd700");
        }
    });

    // Powerups
    powerups.forEach(p => {
        if(p.active && checkHit(bibou.x, bibou.y, bibou.w, bibou.h, p.x-20, p.y-20, 40, 40)) {
            p.active = false;
            if(p.type === 'shield') bibou.shield = true;
            if(p.type === 'jump') bibou.superJump = 500;
        }
    });
    if(bibou.superJump > 0) bibou.superJump--;

    // Hazards & Lives
    if(invulFrame > 0) invulFrame--;
    else {
        spikes.forEach(s => {
            if(checkHit(bibou.x, bibou.y, bibou.w, bibou.h, s.x, s.y, s.w, s.h, 8)) triggerDeath();
        });
        if(bibou.y > canvas.height + 100) triggerDeath(true);
    }

    // Flag / Next Level
    if(Math.abs(bibou.x - flag.x) < 50 && Math.abs(bibou.y - flag.y) < 150) {
        if(level >= 3) showMenu("VICTOIRE TOTALE !", "Les Bibous ont sauvÃ© le futur ! Score: " + score, "REJOUER");
        else {
            gameState = 'next_level';
            showMenu("NIVEAU RÃ‰USSI", "Bravo Tintin ! MÃ©lanie t'attend au niveau suivant.", "CONTINUER");
        }
    }

    // Cam
    let targetCam = bibou.x - canvas.width * 0.3;
    if(targetCam < 0) targetCam = 0;
    cameraX += (targetCam - cameraX) * 0.1;

    // HUD Update
    document.getElementById('vies-count').innerText = "â™¥".repeat(lives);
}

function triggerDeath(fell = false) {
    if(bibou.shield && !fell) {
        bibou.shield = false;
        invulFrame = 120;
        return;
    }
    
    lives--;
    if(lives <= 0) {
        showMenu("GAME OVER", "Les Bibous sont KO. Retente ta chance !", "RECOMMENCER");
        gameState = 'gameover';
    } else {
        invulFrame = 120;
        // Petit saut en arriÃ¨re pour sÃ©curitÃ©
        bibou.vx = -10;
        bibou.vy = -10;
        if(fell) {
            bibou.x -= 200;
            bibou.y = 0;
        }
    }
}

function showMenu(title, text, btn) {
    document.getElementById('msg-title').innerText = title;
    document.getElementById('msg-text').innerText = text;
    document.getElementById('message-box').querySelector('button').innerText = btn;
    document.getElementById('message-box').style.display = 'block';
}

function draw() {
    const theme = THEMES[level-1];
    
    // Background
    ctx.fillStyle = theme.bg;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Parallax Skyline
    ctx.fillStyle = "rgba(255,255,255,0.05)";
    buildings.forEach(b => {
        let bx = (b.x - cameraX * b.speed) % (canvas.width + 500);
        if(bx < -300) bx += canvas.width + 800;
        ctx.fillRect(bx, canvas.height - b.h, b.w, b.h);
    });

    ctx.save();
    ctx.translate(-cameraX, 0);

    // Platforms
    ctx.fillStyle = "#000";
    ctx.strokeStyle = theme.color;
    ctx.lineWidth = 3;
    platforms.forEach(p => {
        if(p.x + p.w > cameraX && p.x < cameraX + canvas.width) {
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.strokeRect(p.x, p.y, p.w, p.h);
        }
    });

    // Spikes
    ctx.fillStyle = "#ff4757";
    spikes.forEach(s => {
        ctx.beginPath();
        ctx.moveTo(s.x, s.y+s.h); ctx.lineTo(s.x+s.w/2, s.y); ctx.lineTo(s.x+s.w, s.y+s.h);
        ctx.fill();
    });

    // Coins
    ctx.fillStyle = "#ffd700";
    coins.forEach(c => {
        if(!c.collected) {
            ctx.beginPath();
            ctx.arc(c.x, c.y + Math.sin(gameTime*2)*5, c.r, 0, Math.PI*2);
            ctx.fill();
        }
    });

    // Powerups
    powerups.forEach(p => {
        if(p.active) {
            ctx.fillStyle = (p.type === 'shield') ? '#00ccff' : '#00ff66';
            ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
            ctx.fillRect(p.x-15, p.y-15 + Math.sin(gameTime*3)*8, 30, 30);
            ctx.shadowBlur = 0;
        }
    });

    // Flag
    ctx.fillStyle = "white"; ctx.fillRect(flag.x, flag.y, 4, 100);
    ctx.fillStyle = theme.color;
    ctx.beginPath();
    ctx.moveTo(flag.x, flag.y); ctx.lineTo(flag.x+60, flag.y+25); ctx.lineTo(flag.x, flag.y+50);
    ctx.fill();

    // Bibou
    if(!(invulFrame > 0 && Math.floor(Date.now()/100)%2 === 0)) {
        drawBibou();
    }

    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

function drawBibou() {
    ctx.save();
    ctx.translate(bibou.x + bibou.w/2, bibou.y + bibou.h/2);
    if(bibou.dir === -1) ctx.scale(-1, 1);

    // Glow if powerup
    if(bibou.superJump > 0) { ctx.shadowBlur = 15; ctx.shadowColor = "#0f6"; }

    // Corps
    ctx.fillStyle = "#e74c3c";
    ctx.beginPath(); ctx.roundRect(-20, -25, 40, 50, 8); ctx.fill();
    // TÃªte
    ctx.fillStyle = "#2c3e50";
    ctx.beginPath(); ctx.arc(0, -32, 15, 0, Math.PI*2); ctx.fill();
    // VisiÃ¨re
    ctx.fillStyle = "#0ff"; ctx.fillRect(4, -36, 10, 5);

    // Shield effect
    if(bibou.shield) {
        ctx.strokeStyle = "#0cf"; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(0,0, 45, 0, Math.PI*2); ctx.stroke();
    }

    ctx.restore();
}

function createParticles(x, y, n, color) {
    for(let i=0; i<n; i++) {
        // Simple particle logic could go here if needed
    }
}

function loop() {
    if(gameState === 'playing') {
        draw();
    }
}

// Init
resize();
document.getElementById('message-box').style.display = 'block';
</script>
</body>
</html>

